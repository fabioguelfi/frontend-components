<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-spinner/paper-spinner.html">

<dom-module id="qa-loading">

	<template>
		<style include="iron-flex iron-flex-alignment"></style>
		<style is="custom-style">
			:host {
				@apply(--layout-vertical);
				@apply(--layout-flex);
			}
			paper-spinner, .message {
				@apply(--layout-self-center);
				text-align: center;
				margin: 16px;
			}
			.message a {
				font-size: 0.86em;
			}
		</style>
		<template is="dom-if" if="[[loading]]">
			<paper-spinner active="[[loading]]"></paper-spiner>
		</template>
		<template is="dom-if" if="[[!loading]]">
			<template is="dom-if" if="[[!isEmpty]]">
				<div>
					<content></content>
				</div>
			</template>
			<template is="dom-if" if="[[isEmpty]]">
				<div class="message">{{messageForEmptyState}}</div>
			</template>
			<template is="dom-if" if="[[error]]">
				<div class="message">
					<div>Ocorreu uma falha</div>
					<a href$="{{loader.url}}" target="_blank">{{error}}</a>
				</div>
			</template>
		</template>
	</template>

	<script>

		Polymer({
			is: "qa-loading",
			properties: {
				loader: {
					type: HTMLElement,
					observer: 'onLoaderChange'
				},
				loading: {
					type: Boolean,
					value: false
				},
				message: {
					type: String,
					value: '',
					observer: 'messageIsDeprecated'
				},
				messageForEmptyState: {
					type: String,
					value: ''
				},
				isEmpty: {
					type: Boolean,
					value: false
				},
				error: {
					type: String,
					value: ''
				}
			},
			messageIsDeprecated: function(message) {
				console.log('qa-loading.message is deprecated');
				this.set('messageForEmptyState', message);
				this.set('isEmpty', Boolean(message.length));
			},
			onLoaderChange: function(loader) {
				if (this._oldLoader) {
					this.unlisten(loader, 'request', 'onRequest');
					this.unlisten(loader, 'response', 'onResponse');
					this.unlisten(loader, 'error', 'onError');
					delete this._oldLoader;
				}
				if (typeof loader === 'string') {
					this.set('loader', this.domHost.$[loader]);
					return;
				}
				if (loader) {
					this.listen(loader, 'request', 'onRequest');
					this.listen(loader, 'response', 'onResponse');
					this.listen(loader, 'error', 'onError');
					this._oldLoader = loader;
				}
			},
			onRequest: function(e) {
				this.set('error', '');
				this.set('loading', true);
			},
			onResponse: function(e) {
				this.set('loading', false);
			},
			onError: function(e) {
				this.set('error', e.detail.error.message);
				this.set('loading', false);
			}
		});
	</script>

</dom-module>
