<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../../../bower_components/iron-input/iron-input.html">
<link rel="import" href="../../../bower_components/iron-dropdown/iron-dropdown.html">
<link rel="import" href="../../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../../../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../../qa-loading/v1/qa-loading.html">
<link rel="import" href="../../qa-styles/v1/qa-styles.html">
<link rel="import" href="../../qa-behavior/v1/qa-behavior.html">

<link rel="import" href="./qa-search-property-item.html">
<link rel="import" href="./qa-search-person-item.html">
<link rel="import" href="./qa-search-task-item.html">

<dom-module id="qa-search">

	<template>
		<style include="iron-flex iron-flex-alignment"></style>
		<style include="qa-styles"></style>
		<style is="custom-style">
			:host {
				@apply(--layout-horizontal);
				@apply(--layout-center);
				width: 480px;
			}
			#menu {
				background-color: var(--qa-darker-color);
				padding: 0px 8px 0px 0px;
				position: relative;
			}
			iron-icon, paper-icon-button {
				color: #84b1ca;
			}
			#menu > iron-icon {
				position: absolute;
				right: 0px;
			}
			paper-icon-button {
				padding: 6px;
			}
			paper-menu-button {
				padding: 0px;
			}
			paper-icon-item {
				--paper-item-icon-width: 32px;
			}
			input {
				@apply(--layout-vertical);
				@apply(--layout-flex);
				font-size: 16px;
				border: 0px;
				height: 100%;
				padding: 0px 10px;
				color: var(--qa-text-color);
				background-color: var(--qa-dark-color);
			}
			input::-webkit-input-placeholder {
				color: var(--qa-disabled-color);
			}
			input:-moz-placeholder {
				color: var(--qa-disabled-color);
			}
			input::-moz-placeholder {
				color: var(--qa-disabled-color);
			}
			input:-ms-input-placeholder {
				color: var(--qa-disabled-color);
			}
			.dropdown-content {
				@apply(--shadow-elevation-2dp);
				border-radius: 2px;
				background: white;
			}
			.footer {
				cursor: pointer;
				color: var(--qa-dark-color);
				padding: 2px 16px;
				text-align: center;
				font-weight: normal;
				font-size: 12px;
			}
			.section {
				@apply(--layout-horizontal);
				padding: 8px 12px;
			}
			.section:not(:last-of-type) {
				border-bottom: 1px solid var(--qa-light-divider-color);
			}
			.section > div {
				@apply(--layout-flex);
			}
			.footer, .section > iron-icon {
				margin: 12px 8px 12px 0px;
			}
		</style>
		<div id="menu">
			<iron-icon id="arrow" icon="arrow-drop-down"></iron-icon>
			<paper-menu-button >
				<paper-icon-button icon="[[selectedType.icon]]" class="dropdown-trigger"></paper-icon-button>
				<paper-menu class="dropdown-content" selected="{{selectedTypeIndex}}">
					<template is="dom-repeat" items="[[types]]">
						<paper-icon-item>
							<iron-icon icon="[[item.icon]]" item-icon></iron-icon>
							{{item.label}}
						</paper-icon-item>
					</template>
				</paper-menu>
			</paper-menu-button>
		</div>
		<input is="iron-input" bind-value="{{value}}" on-keydown="onKeydown" on-input="onInput" placeholder="Buscar...">
		<iron-dropdown id="dropdown" no-overlap dynamic-align allow-outside-scroll>
			<qa-loading class="dropdown-content" loader="ajax">
				<template is="dom-if" if="[[selectedType.showPeople]]">
					<div class="section">
						<iron-icon icon="[[types.1.icon]]" item-icon></iron-icon>
						<div>
							<template is="dom-repeat" items="[[result.users.items]]">
								<qa-search-person-item item="[[item]]" on-tap="onTap"></qa-search-person-item>
							</template>
							<div class="footer" on-tap="onAllPeopleTap">
								{{getMessage('pessoas', value, result.users.count)}}
							</div>
						</div>
					</div>
				</template>
				<template is="dom-if" if="[[selectedType.showProperties]]">
					<div class="section">
						<iron-icon icon="[[types.2.icon]]" item-icon></iron-icon>
						<div>
							<template is="dom-repeat" items="[[result.properties.items]]">
								<qa-search-property-item item="[[item]]" on-tap="onTap"></qa-search-property-item>
							</template>
							<div class="footer" on-tap="onAllPropertiesTap">
								{{getMessage('imóveis', value, result.properties.count)}}
							</div>
						</div>
					</div>
				</template>
				<template is="dom-if" if="[[selectedType.showTasks]]">
					<div class="section">
						<iron-icon icon="[[types.3.icon]]" item-icon></iron-icon>
						<div>
							<template is="dom-repeat" items="[[result.tasks.items]]">
								<qa-search-task-item item="[[item]]" on-tap="onTap"></qa-search-task-item>
							</template>
							<div class="footer" on-tap="onAllTasksTap">
								{{getMessage('tarefas', value, result.tasks.count)}}
							</div>
						</div>
					</div>
				</template>
			</qa-loading>
		</iron-dropdown>
		<iron-ajax
			id="ajax"
			url="/api/search"
			params="[[getParams(value, delegating, page, size, selectedType)]]"
			loading="{{isLoading}}"
			on-request="onRequest"
			on-response="onResponse"
			on-error="onResponse"
			with-credentials>
		</iron-ajax>
	</template>
	<script>
		Polymer({
			is: 'qa-search',
			properties: {
				value: {
					type: String,
					value: ''
				},
				delegateType: {
					type: String,
					value: ''
				},
				delegateValue: {
					type: String,
					observer: 'onDelegateValueChange',
					notify: true
				},
				delegateResult: {
					type: Object,
					notify: true
				},
				delegating: {
					type: Boolean,
					computed: 'isDelegating(selectedType, delegateType)'
				},
				minLength: {
					type: Number,
					notify: true,
					value: 3
				},
				isLoading: Boolean,
				loading: {
					type: Boolean,
					notify: true,
					computed: 'getLoading(isLoading, delegating)'
				},
				page: {
					type: Number,
					notify: true,
					value: 0,
					observer: 'onPageChange'
				},
				size: {
					type: Number,
					value: 10
				},
				result: Object,
				selectedType: Object,
				selectedTypeIndex: {
					type: Number,
					value: 0
				},
				types: {
					type: Array,
					value: function() {
						return [{
							id: 'all',
							size: 3,
							label: 'Todos',
							showTasks: true,
							showPeople: true,
							showProperties: true,
							icon: 'search'
						}, {
							id: 'users',
							size: 10,
							label: 'Pessoas',
							showPeople: true,
							icon: 'account-circle'
						}, {
							id: 'properties',
							size: 10,
							label: 'Imoveis',
							showProperties: true,
							icon: 'social:domain'
						}, {
							id: 'tasks',
							size: 10,
							label: 'Tarefas',
							showTasks: true,
							icon: 'assignment-turned-in'
						}];
					}
				}
			},
			behaviors: [ Polymer.IronResizableBehavior ],
			listeners: {
				'iron-resize': 'onResize'
			},
			observers: [
				'onDelegate(types, delegateType, page)',
				'onSelectType(types, selectedTypeIndex)'
			],
			onSelectType: function(types, selectedTypeIndex) {
				this.set('selectedType', types[selectedTypeIndex]);
				if (this.delegating && this.delegateValue) {
					this.set('value', this.delegateValue);
				} else {
					this.doRequest();
				}
			},
			doRequest: function() {
				if (this.value.length >= this.minLength) {
					this.async(function() {
						this.$.ajax.generateRequest();
					});
					return true;
				} else {
					return false;
				}
			},
			onDelegate: function(types, delegateType, page) {
				/* page is here to force the
				 * delegated type on page change */
				types.forEach(function(type, index) {
					if (type.id == delegateType) {
						this.set('selectedTypeIndex', index);
					}
				}, this);
			},
			onDelegateValueChange: function(value) {
				if (this.value == value) {
					return;
				}
				this.set('value', value);
				this.doRequest();
			},
			getParams: function(value, delegating, page, size, selectedType) {
				size = delegating ? size : selectedType.size;
				var offset = size * (delegating ? page : 0);
				return { query: value, size: size, offset: offset };
			},
			onPageChange: function(page) {
				this.doRequest();
			},
			isDelegating: function(selectedType, delegateType) {
				return selectedType.id == delegateType;
			},
			getLoading: function(isLoading, delegating) {
				return isLoading && delegating;
			},
			onKeydown: function(event) {
				if (event.keyCode == 13) {
					this.doRequest();
				}
			},
			onInput: function(event) {
				var value = event.target.value;
				if (!this.doRequest()) {
					this.$.dropdown.close();
				}
				if (this.delegating) {
					this.set('delegateValue', value);
					this.set('page', 0);
				}
			},
			onRequest: function() {
				if (this.selectedType.id != this.delegateType) {
					this.$.dropdown.open();
				}
			},
			onResize: function() {
				this.$$('paper-menu-button').verticalOffset = this.offsetHeight;
				this.$.dropdown.style.minWidth = this.offsetWidth + 'px';
			},
			onResponse: function(event) {
				var response = event.detail.response;
				if (this.delegating) {
					this.set('delegateResult', response[this.selectedType.id]);
				} else {
					this.set('result', response);
					this.async(function() {
						this.$.dropdown.notifyResize();
					}, 100);
				}
			},
			getMessage: function(type, value, count) {
				if (count) {
					return 'Ver todos os resultados de ' + type;
				} else {
					return 'Sua busca - ' + value + ' - não encontrou ' + type;
				}
			},
			onAllPeopleTap: function() {
				var url = '@@ACCOUNTS_URL/busca?query=' + this.value;
				window.open(url, '_blank');
			},
			onAllPropertiesTap: function() {
				var url = '@@PROPERTIES_URL/busca?query=' + this.value;
				window.open(url, '_blank');
			},
			onAllTasksTap: function() {
				var url = '@@USTASKS_URL/busca?query=' + this.value;
				window.open(url, '_blank');
			},
			onTap: function(event) {
				window.open(event.model.item.viewUrl, '_blank');
			}
		});

	</script>
</dom-module>

