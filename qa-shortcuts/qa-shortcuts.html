<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">

<link rel="import" href="../qa-behavior/v1/qa-behavior.html">

<dom-module id="qa-shortcuts">
	<template>
		<iron-a11y-keys target="[[cmdPalTarget]]" keys="esc" on-keys-pressed="closeCommandPallete"></iron-a11y-keys>
		<iron-a11y-keys target="[[cmdPalTarget]]" keys="ctrl+alt+3" on-keys-pressed="openCommandPallete" stop-keyboard-event-propagation="true"></iron-a11y-keys>
		<paper-dialog id="dlgOnboardingShortcuts" modal="true">
			<h1>YES, nós temos atalhos!</h1>
			<p>
				Para facilitar sua vida, nós colocamos atalhos dentro do CRM.<br />
				Veja alguns deles:
			</p>
			<ul>
				<li><span class="shortcut">CTRL+ALT+3</span>Abrir Busca/Lista de atalhos</li>
				<template is="dom-repeat" items="[[allCommands]]">
					<template is="dom-if" if="[[!item.depends]]">
						<li><span class="shortcut">[[item.shortcut]]</span>[[item.description]]</li>
					</template>
				</template>
			</ul>
			<p>
				Lembre-se: para pesquisar os atalhos disponíveis você pode usar o "CTRL+ALT+3"
			</p>
			<paper-button raised active on-tap="closeOnboarding">Ok, entendi!</paper-button>
			<paper-checkbox checked="{{dontShowOnboarding}}">Já entendi e não quero mais ver essa tela :)</paper-checkbox>
		</paper-dialog>
		<template is="dom-repeat" items="[[listaComandos]]">
			<iron-a11y-keys target="[[cmdPalTarget]]" keys="[[item.shortcut]]" on-keys-pressed="_actOnShortcut" data-command-index="[[index]]">
			</iron-a11y-keys>
		</template>
		<paper-dialog id="dlgCmdPallete" modal="true">
			<paper-input id="commandFilterInput" no-label-float="true" label="Digite o comando" value="{{commandFilter}}" autofocus="true"></paper-input>
			<iron-a11y-keys target="[[commandFilterNode]]" keys="esc enter down up" on-keys-pressed="commandFilterKeyPressed"></iron-a11y-keys>
			<paper-listbox id="listCmd" selected="{{selectedCommandIndex}}">
				<template is="dom-repeat" items="[[listaFiltrada]]">
					<paper-item on-tap="_onCommandTap" data-command-index="[[index]]"><span class="shortcut">[[item.shortcut]]</span>[[item.description]]</paper-item>
				</template>
			</paper-listbox>
		</paper-dialog>
		<style is="custom-style">
			#dlgOnboardingShortcuts ul,
			#dlgOnboardingShortcuts li {
				list-style: none;
			}
			#dlgOnboardingShortcuts li {
				display:block;
				padding: 5px 10px;
			}
			#dlgOnboardingShortcuts paper-button {
				background-color: #00A2F6;
				color: #ffffff;
				font-weight: bold;
				padding: 10px 22px;
				margin-left: 24px;
			}
			paper-item .shortcut, li .shortcut {
				border-radius: 5px;
				background-color: #888888;
				color: #ffffff;
				min-width: 80px;
				text-align: center;
				padding: 4px 8px;
				font-size: 9pt;
				position: absolute;
				right: 0;
				font-weight: bold;
				margin-right: 20px;
			}
			paper-item.iron-selected .shortcut {
				background-color: #666666;
				color: #eeeeee;
			}
			paper-dialog#dlgCmdPallete {
				width: 70%;
				min-width: 300px;
			}
			#listCmd paper-item {
				--paper-item-selected: {
					background: #0288D1;
					font-weight: bold;
					color: #ffffff;
				};
				--paper-item-focused-before: {
					opacity: 0;
				};
			}
		</style>
	</template>
	<script>
		Polymer({
			is: 'qa-shortcuts',
			behaviors: [ QuintoAndar.Behavior ],
			properties: {
				house: { type : Object, observer: '_contextChanged' },
				tenant: { type : Object, observer: '_contextChanged' },
				owner: { type : Object, observer: '_contextChanged' },
				task: { type : Object, observer: '_contextChanged' },
				cmdPalTarget: {
					type: Object
				},
				commandDisplayMaxCount : {
					type: Number,
					value: 5
				},
				listaFiltrada: Array,
				allCommands: Array,
				listaComandos: {
					type: Array,
					computed: 'availableCommands(allCommands,extraCommands)'
				},
				commandFilter : { type : String, observer: '_commandFiltered' },
				selectedCommandIndex: Number,
				selectedCommand: {
					type: Object,
					computed: 'getSelectedCommand(selectedCommandIndex, listaFiltrada)'
				},
				extraCommands: {
					type: Array,
					value: []
				},
				tasksUrl: {type: String, value:""},
				propertiesUrl: {type: String, value:""},
				accountsUrl: {type: String, value:""},
				searchUrl: {type: String, value:""},
				dontShowOnboarding: false
			},
			behaviors: [ QuintoAndar.Behavior ],
			closeOnboarding: function() {
				if (this.dontShowOnboarding) {
					var crmShortcut = document.cookie.match(new RegExp("(; *)?crmShortcutsOnboarding=([^;]*)"));
					if (!crmShortcut || crmShortcut[2] != "yes") {
						document.cookie = "crmShortcutsOnboarding=yes; path=/";
					}
				}
				this.$.dlgOnboardingShortcuts.close()
			},
			ready: function() {
				var crmShortcut = document.cookie.match(new RegExp("(; *)?crmShortcutsOnboarding=([^;]*)"));
				if (!crmShortcut || crmShortcut[2] != "yes") {
					this.$.dlgOnboardingShortcuts.open()
				}
				
				this.set('cmdPalTarget',document.body)
				this.set('allCommands',[
					{description:"Abrir página apartamento/imóvel", shortcut:"ctrl+shift+a", depends: ["house"],
						action: this.openUsPropertiesUrl('/imoveis/',['house','id'])
					},
					{description:"Abrir anúncio apartamento/imóvel", shortcut:"ctrl+shift+u", depends: ["house","searchUrl"],
						action: this.openSearchUrl('/imovel/',['house','id'])
					},
					{description:"Abrir página inquilino", shortcut:"ctrl+shift+i", depends: ["tenant"],
						action: this.openUsAccountsUrl('/usuarios/',['tenant','id'])
					},
					{description:"Abrir página proprietário", shortcut:"ctrl+shift+p", depends: ["owner"],
						action: this.openUsAccountsUrl('/usuarios/',['owner','id'])
					},
					{description:"Abrir essa tarefa/task em nova aba", shortcut:"ctrl+alt+t", depends: ["task"],
						action: this.openUsTasksUrl('/tarefas?taskId=',['task','_id'])
					},
					{description:"Abrir busca em nova aba", shortcut:"ctrl+alt+b", action: this.openUsTasksUrl('/busca')},
					{description:"Abrir tarefas em nova aba", shortcut:"ctrl+alt+b", action: this.openUsTasksUrl('/tarefas')},
					{description:"Abrir relatórios em nova aba", shortcut:"ctrl+alt+r", action: this.openUsTasksUrl('/relatorios')},
					{description:"Abrir performance em nova aba", shortcut:"ctrl+alt+d", action: this.openUsTasksUrl('/dashboard/')},
					{description:"Ligar inquilino", shortcut:"ctrl+alt+i", depends: ["tenant"], action: this.callTenant.bind(this)},
					{description:"Ligar proprietário",shortcut:"ctrl+alt+p", depends: ["owner"], action: this.callOwner.bind(this)}
				]);
				this._commandFiltered();
				setTimeout(function(){
						this.set('cmdPalTarget',document.body)
				}.bind(this),1000)
				this.set("commandFilterNode",this.$.commandFilterInput);
			},
			getSelectedCommand: function(selectedCommandIndex, listaFiltrada) {
				return listaFiltrada[selectedCommandIndex];
			},
			commandFilterKeyPressed : function(e) {
				var keyName = e.detail.keyboardEvent.code;
				if (keyName == "Enter") {
					if (this.selectedCommand) {
						this.executeShortcut(this.selectedCommand);
					}
				} else if (keyName == "Esc") {
					this.closeCommandPallete();
				} else if (keyName == "ArrowDown" || keyName == "ArrowUp") {
					var signal = keyName == "ArrowUp" ? -1 : +1
					var current = parseInt(this.selectedCommandIndex || ((signal < 0)?this.listaFiltrada.length:-1))
					var newVal = current + signal
					if (newVal  >= 0 && newVal < this.listaFiltrada.length) {
						this.set("selectedCommandIndex",""+newVal)
					}
				}
			},
			_contextChanged : function(){
				this.set('allCommands',this.allCommands.slice(0))
				this._commandFiltered()
			},
			availableCommands : function(allCommands,extraCommands){
				var available = [];
				var filterCommands = function(commands, avail){
					commands.forEach(function(cmd){
						['house','tenant','owner','task','searchUrl'].every(function(dependency){
							if (!cmd.depends || (this[dependency] && cmd.depends.find(function(it){return it == dependency}))){
								avail.push(cmd);
								return false;
							}
							return true;
						}.bind(this))
					}.bind(this));
				}.bind(this)
				filterCommands(allCommands, available);
				filterCommands(extraCommands, available);
				return available;
			},
			_commandFiltered : function(){
				var filt = [];
				var filtering = removeDiacritics((this.commandFilter||'').toLowerCase());
				for(cmdIdx in this.listaComandos) {
					var cmd = this.listaComandos[cmdIdx];
					if(removeDiacritics(cmd.description.toLowerCase()).indexOf(filtering) >= 0) {
						filt.push(cmd)
					}
					if (filt.length >= this.commandDisplayMaxCount) {
						break;
					}
				}
				this.set('listaFiltrada',filt)
				this.set('selectedCommandIndex',"0")
			},
			openCommandPallete: function(e) {
				if (! this.$.dlgCmdPallete.opened) {
					this.$.dlgCmdPallete.open()
				} else {
					this.closeCommandPallete();
				}
			},
			closeCommandPallete: function() {
				if (this.$.dlgCmdPallete.opened) {
					this.$.dlgCmdPallete.close()
					this.set("commandFilter","")
				}
			},
			_onCommandTap: function(event) {
				// this.set('selectedCommandItem',event.srcElement)
				setTimeout(function(){
					this.executeShortcut(this.selectedCommand)
				}.bind(this),1)
			},
			_actOnShortcut: function(event) {
				var cmdIndex = event.srcElement.dataCommandIndex;
				this.executeShortcut(this.listaComandos[cmdIndex], true);
			},
			executeShortcut:function(item, fromShortcut){
				var url = item.action();
				if (url) {
					if (url.match(/^((http)|(\/)).*$/g)) {
						window.open(url)
					}
					if (url.match(/^sip:.*$/g)) {
						window.location = url
					}
				}
				this.countCommand({item:item,fromShortcut:(fromShortcut||false)})
				setTimeout(function(){
					this.closeCommandPallete();
				}.bind(this),10);
			},
			//this is to get statistics of shortcut usage
			countCommand: function(payload) {
				fromShortcut = payload.fromShortcut
				item = payload.item
				usage = {origin:fromShortcut?item.shortcut:'pallete',command:item.description,at:new Date()}
				console.info(usage)
				this.updateUsage(usage)
			},
			updateUsage:function(usage){
				var key = 'COUNT'
				if (window.localStorage && window.localStorage.getItem) {
					var current = JSON.parse(window.localStorage.getItem(key)||'[]')
					current.push(usage)
					window.localStorage.setItem(key, JSON.stringify(current))
				}
			},
			evaluatePath:function(pathArray) {
				var val = this.get(pathArray[0]);
				pathArray.slice(1).forEach(function(pathPiece){
					val = val[pathPiece];
				})
				return val;
			},
			openSearchUrl : function() {
				return this.openUrlWithContextUrl('searchUrl', arguments);
			},
			openUsTasksUrl : function() {
				return this.openUrlWithContextUrl('tasksUrl', arguments);
			},
			openUsAccountsUrl : function() {
				return this.openUrlWithContextUrl('accountsUrl', arguments);
			},
			openUsPropertiesUrl : function() {
				return this.openUrlWithContextUrl('propertiesUrl', arguments);
			},
			/**
				calling like this ensures that the call will use the current context values
			**/
			openUrlWithContextUrl:function(contextNameUrl){
				var args = arguments[1]
				return function() {
					return this.openUrl(this[contextNameUrl], args)()
				}.bind(this);
			},
			openUrl : function(baseUrl, args) {
				return function() {
					var action = baseUrl;
					for(argIndex in args) {
						arg = args[argIndex]
						if (typeof arg === "string") {
							action += arg
						} else if (Array.isArray(arg)) {
							action += (this.evaluatePath.bind(this))(arg);
						}
					}
					return action;
				}.bind(this)
			},
			PhoneNumberFields : [
				'telefone','phone','phoneNumber','telefonePrincipal','telefoneSecundario',
				'telefoneComercial','telefoneAnunciante','telefoneAnuncianteDois'
			],
			call: function(user) {
				if (user) {
					var phoneKey = this.PhoneNumberFields.find(function(fname){
						return user[fname]
					})
					var numberToCall = user[phoneKey]
					if (numberToCall) {
						return 'sip: ' + numberToCall.replace(/[^0-9]/g,'').replace(/^\+55/g,'0');
					}
				}
			},
			callOwner: function() {
				return this.call(this.owner)
			},
			callTenant: function() {
				return this.call(this.tenant)
			}
		});
	</script>
</dom-module>

