<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">

<link rel="import" href="../qa-behavior/v1/qa-behavior.html">

<dom-module id="qa-shortcuts">
	<template>
		<iron-a11y-keys target="[[cmdPalTarget]]" keys="esc" on-keys-pressed="closeCommandPallete"></iron-a11y-keys>
		<iron-a11y-keys target="[[cmdPalTarget]]" keys="ctrl+alt+3" on-keys-pressed="openCommandPallete" stop-keyboard-event-propagation="true"></iron-a11y-keys>
		<paper-dialog id="dlgOnboardingShortcuts" modal="true">
			<h1>YES, nós temos atalhos!</h1>
			<p>
				Para facilitar sua vida, nós colocamos atalhos dentro do CRM.<br />
				Veja alguns deles:
			</p>
			<ul>
				<li><span class="shortcut">CTRL+ALT+3</span>Abrir Busca/Lista de atalhos</li>
				<template is="dom-repeat" items="[[allCommands]]">
					<template is="dom-if" if="[[!item.depends]]">
						<li><span class="shortcut">[[item.shortcut]]</span>[[item.description]]</li>
					</template>
				</template>
			</ul>
			<p>
				Lembre-se: para pesquisar os atalhos disponíveis você pode usar o "CTRL+ALT+3"
			</p>
			<paper-button raised active on-tap="closeOnboarding">Ok, entendi!</paper-button>
		</paper-dialog>
		<template is="dom-repeat" items="[[listaComandos]]">
			<iron-a11y-keys target="[[cmdPalTarget]]" keys="[[item.shortcut]]" on-keys-pressed="_actOnShortcut" data-command-index="[[index]]">
			</iron-a11y-keys>
		</template>
		<paper-dialog id="dlgCmdPallete" modal="true">
			<paper-input id="commandFilterInput" no-label-float="true" label="Digite o comando" value="{{commandFilter}}"></paper-input>
			<paper-listbox id="listCmd">
				<template is="dom-repeat" items="[[listaFiltrada]]">
					<paper-item on-tap="_onCommandTap" data-command-index="[[index]]"><span class="shortcut">[[item.shortcut]]</span>[[item.description]]</paper-item>
				</template>
			</paper-listbox>
		</paper-dialog>
		<style is="custom-style">
			#dlgOnboardingShortcuts ul,
			#dlgOnboardingShortcuts li {
				list-style: none;
			}
			#dlgOnboardingShortcuts li {
				display:block;
				padding: 5px 10px;
			}
			#dlgOnboardingShortcuts paper-button {
				background-color: #00A2F6;
				color: #ffffff;
				font-weight: bold;
				padding: 10px 22px;
				margin-left: 24px;
			}
			paper-item .shortcut, li .shortcut {
				border-radius: 5px;
				background-color: #888888;
				color: #ffffff;
				min-width: 80px;
				text-align: center;
				padding: 4px 8px;
				font-size: 9pt;
				position: absolute;
				right: 0;
				font-weight: bold;
				margin-right: 20px;
			}
			paper-item:focus .shortcut {
				background-color: #666666;
				color: #eeeeee;
			}
			paper-dialog#dlgCmdPallete {
				width: 70%;
				min-width: 300px;
			}
			#listCmd paper-item {
				--paper-item-focused: {
					background: #0288D1;
					font-weight: bold;
					color: #ffffff;
				};
				--paper-item-focused-before: {
					opacity: 0;
				};
			}
		</style>
	</template>
	<script>
		Polymer({
			is: 'qa-shortcuts',
			properties: {
				house: { type : Object, observer: '_contextChanged' },
				tenant: { type : Object, observer: '_contextChanged' },
				owner: { type : Object, observer: '_contextChanged' },
				task: { type : Object, observer: '_contextChanged' },
				cmdPalTarget: {
					type: Object
				},
				commandDisplayMaxCount : 5,
				listaFiltrada: Array,
				allCommands: Array,
				listaComandos: {
					type: Array,
					computed: 'availableCommands(allCommands,extraCommands)'
				},
				commandFilter : { type : String, observer: '_commandFiltered' },
				selectedCommandItem: Object,
				selectedCommand: {
					type: Object,
					computed: 'getSelectedCommand(selectedCommandItem, listaFiltrada)'
				},
				extraCommands: {
					type: Array,
					value: []
				},
				tasksUrl: {type: String, value:""},
				propertiesUrl: {type: String, value:""},
				accountsUrl: {type: String, value:""}
			},
			behaviors: [ QuintoAndar.Behavior ],
			closeOnboarding: function() {
				var crmShortcut = document.cookie.match(new RegExp("(; *)?crmShortcutsOnboarding=([^;]*)"));
				if (!crmShortcut || crmShortcut[2] != "yes") {
					document.cookie = "crmShortcutsOnboarding=yes; path=/";
				}
				this.$.dlgOnboardingShortcuts.close()
			},
			ready: function() {
				var crmShortcut = document.cookie.match(new RegExp("(; *)?crmShortcutsOnboarding=([^;]*)"));
				if (!crmShortcut || crmShortcut[2] != "yes") {
					this.$.dlgOnboardingShortcuts.open()
				}
				
				this.set('cmdPalTarget',document.body)
				this.set('allCommands',[
					{description:"Abrir página apartamento", shortcut:"ctrl+alt+a", depends: ["house"], action: this.openUsPropertiesUrl('/imoveis/',['house','id'])},
					{description:"Abrir página inquilino", shortcut:"ctrl+alt+i", depends: ["tenant"], action: this.openUsAccountsUrl('/usuarios/',['tenant','id'])},
					{description:"Abrir página proprietário", shortcut:"ctrl+shift+p", depends: ["owner"], action: this.openUsAccountsUrl('/usuarios/',['owner','id'])},
					{description:"Abrir task em nova aba", shortcut:"ctrl+alt+t", depends: ["task"], action: this.openUsTasksUrl('/tarefas?taskId=',['task','_id'])},
					{description:"Abrir busca em nova aba", shortcut:"ctrl+alt+b", action: this.openUsTasksUrl('/busca')},
					{description:"Abrir relatório funil mensal", shortcut:"ctrl+alt+m", action: this.openUsTasksUrl('/relatorios')},
					{description:"Ligar inquilino", shortcut:"ctrl+alt+i", depends: ["tenant"], action: this.callTenant.bind(this)},
					{description:"Ligar proprietário",shortcut:"ctrl+alt+p", depends: ["owner"], action: this.callOwner.bind(this)}
				]);
				this._commandFiltered();
				setTimeout(function(){
						this.set('cmdPalTarget',document.body)
				}.bind(this),1000)
			},
			getSelectedCommand: function(selectedCommandItem, listaFiltrada) {
				var index = selectedCommandItem.dataCommandIndex;
				return listaFiltrada[index];
			},
			_contextChanged : function(){
				this.set('allCommands',this.allCommands.slice(0))
				this._commandFiltered()
			},
			availableCommands : function(allCommands,extraCommands){
				var available = [];
				var filterCommands = function(commands, avail){
					commands.forEach(function(cmd){
						['house','tenant','owner','task'].every(function(dependency){
							if (!cmd.depends || (this[dependency] && cmd.depends.find(function(it){return it == dependency}))){
								avail.push(cmd);
								return false;
							}
							return true;
						}.bind(this))
					}.bind(this));
				}.bind(this)
				filterCommands(allCommands, available);
				filterCommands(extraCommands, available);
				return available;
			},
			_commandFiltered : function(){
				var filt = [];
				for(cmdIdx in this.listaComandos) {
					var cmd = this.listaComandos[cmdIdx];
					if(cmd.description.toLowerCase().indexOf((this.commandFilter||'').toLowerCase()) >= 0) {
						filt.push(cmd)
					}
					if (filt.length > this.commandDisplayCount) {
						break;
					}
				}
				this.set('listaFiltrada',filt)
			},
			openCommandPallete: function(e) {
				if (! this.$.dlgCmdPallete.opened) {
					this.$.dlgCmdPallete.open()
					setTimeout(function(){
						this.$.commandFilterInput.focus()
					}.bind(this),50)
				} else {
					this.closeCommandPallete();
				}
			},
			closeCommandPallete: function() {
				if (this.$.dlgCmdPallete.opened) {
					this.$.dlgCmdPallete.close()
				}
			},
			_onCommandTap: function(event) {
				this.set('selectedCommandItem',event.srcElement)
				setTimeout(function(){
					var url = this.selectedCommand.action();
					if (url.match(/^((http)|(\/)).*$/g)) {
						window.open(url)
					}
					if (url.match(/^sip:.*$/g)) {
						window.location = url
					}
				}.bind(this),1)
			},
			_actOnShortcut: function(event) {
				debugger
				
				var cmdIndex = event.srcElement.dataCommandIndex;
				var url = this.listaComandos[cmdIndex].action();
				if (url.match(/^((http)|(\/)).*$/g)) {
					window.open(url)
				}
				if (url.match(/^sip:.*$/g)) {
					window.location = url
				}
				this.closeCommandPallete();
			},
			evaluatePath:function(pathArray) {
				var val = this.get(pathArray[0]);
				pathArray.slice(1).forEach(function(pathPiece){
					val = val[pathPiece];
				})
				return val;
			},
			openUsTasksUrl : function() {
				return this.openUrl(this.tasksUrl, arguments);
			},
			openUsAccountsUrl : function() {
				return this.openUrl(this.accountsUrl, arguments);
			},
			openUsPropertiesUrl : function() {
				return this.openUrl(this.propertiesUrl, arguments);
			},
			openUrl : function(baseUrl, args) {
				return function() {
					var action = baseUrl;
					for(argIndex in args) {
						arg = args[argIndex]
						if (typeof arg === "string") {
							action += arg
						} else if (Array.isArray(arg)) {
							action += (this.evaluatePath.bind(this))(arg);
						}
					}
					return action;
				}.bind(this)
			},
			call: function(user) {
				var numberToCall = (user.telefonePrincipal || user.telefoneSecundario || user.telefoneComercial || user.telefoneAnunciante);
				return 'sip: ' + numberToCall.replace(/[^0-9]/g,'').replace(/^\+55/g,'0');
			},
			callOwner: function() {
				return this.call(this.owner)
			},
			callTenant: function() {
				this.call(this.tenant)
			}
		});
	</script>
</dom-module>

