<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">

<link rel="import" href="../qa-behavior/v1/qa-behavior.html">

<dom-module id="qa-shortcuts">
	<template>
		<iron-a11y-keys target="[[cmdPalTarget]]" keys="esc" on-keys-pressed="closeCommandPallete"></iron-a11y-keys>
		<iron-a11y-keys target="[[cmdPalTarget]]" keys="ctrl+alt+3" on-keys-pressed="openCommandPallete" stop-keyboard-event-propagation="true"></iron-a11y-keys>
		<template is="dom-repeat" items="[[listaComandos]]">
			<iron-a11y-keys target="[[cmdPalTarget]]" keys="[[item.shortcut]]" on-keys-pressed="_actOnShortcut" data-command-index="[[index]]">
			</iron-a11y-keys>
		</template>
		<paper-dialog id="dlgCmdPallete" modal="true">
			<paper-input id="commandFilterInput" no-label-float="true" label="Digite o comando" value="{{commandFilter}}"></paper-input>
			<paper-listbox id="listCmd">
				<template is="dom-repeat" items="[[listaFiltrada]]">
					<paper-item on-tap="_onCommandTap" data-command-index="[[index]]"><span class="shortcut">[[item.shortcut]]</span>[[item.description]]</paper-item>
				</template>
			</paper-listbox>
		</paper-dialog>
		<style is="custom-style">
			paper-item .shortcut {
				border-radius: 5px;
				background-color: #888888;
				color: #ffffff;
				min-width: 80px;
				text-align: center;
				padding: 4px 8px;
				font-size: 9pt;
				position: absolute;
				right: 0;
				font-weight: bold;
				margin-right: 20px;
			}
			paper-item:focus .shortcut {
				background-color: #666666;
				color: #eeeeee;
			}
			paper-dialog#dlgCmdPallete {
				width: 70%;
				min-width: 300px;
			}
			#listCmd paper-item {
				--paper-item-focused: {
					background: #0288D1;
					font-weight: bold;
					color: #ffffff;
				};
				--paper-item-focused-before: {
					opacity: 0;
				};
			}
		</style>
	</template>
	<script>
		Polymer({
			is: 'qa-shortcuts',
			properties: {
				house: { type : Object, observer: '_contextChanged' },
				tenant: { type : Object, observer: '_contextChanged' },
				owner: { type : Object, observer: '_contextChanged' },
				task: { type : Object, observer: '_contextChanged' },
				cmdPalTarget: {
					type: Object
				},
				listaFiltrada: Array,
				allCommands: Array,
				listaComandos: {
					type: Array,
					computed: 'availableCommands(allCommands)'
				},
				commandFilter : { type : String, observer: '_commandFiltered' },
				selectedCommandItem: Object,
				selectedCommand: {
					type: Object,
					computed: 'getSelectedCommand(selectedCommandItem, listaFiltrada)'
				}
			},
			behaviors: [ QuintoAndar.Behavior ],
			ready: function() {
				this.set('cmdPalTarget',document.body)
				console.info(this.cmdPalTarget)
				this.set('allCommands',[
					{description:"Abrir página apartamento", shortcut:"ctrl+alt+a", depends: ["house"], action: this.openUsPropertiesUrl('/imoveis/',['house','id'])},
					{description:"Abrir página inquilino", shortcut:"ctrl+alt+i", depends: ["tenant"], action: this.openUsAccountsUrl('/usuarios/',['tenant','id'])},
					{description:"Abrir página proprietário", shortcut:"ctrl+shift+p", depends: ["owner"], action: this.openUsAccountsUrl('/usuarios/',['owner','id'])},
					{description:"Abrir task nova aba", shortcut:"ctrl+alt+t", depends: ["task"], action: this.openUsTasksUrl('/tarefas?taskId=',['task','_id'])},
					{description:"Abrir busca em nova aba", shortcut:"ctrl+alt+b", action: this.openUsTasksUrl('/busca')},
					{description:"Abrir relatório funil mensal", shortcut:"ctrl+alt+m", action: this.openUsTasksUrl('/relatorios')},
					{description:"Ligar inquilino", shortcut:"ctrl+alt+i", depends: ["tenant"], action: this.callTenant.bind(this)},
					{description:"Ligar proprietário",shortcut:"ctrl+alt+p", depends: ["owner"], action: this.callOwner.bind(this)}
				]);
				this._commandFiltered();
				setTimeout(function(){
						this.set('cmdPalTarget',document.body)
				}.bind(this),1000)
			},
			getSelectedCommand: function(selectedCommandItem, listaFiltrada) {
				var index = selectedCommandItem.dataCommandIndex;
				return listaFiltrada[index];
			},
			_contextChanged : function(){
				this.set('allCommands',this.allCommands.slice(0))
				this._commandFiltered()
			},
			availableCommands : function(allCommands){
				var available = [];
				allCommands.forEach(function(cmd){
					['house','tenant','owner','task'].every(function(dependency){
						if (!cmd.depends || (this[dependency] && cmd.depends.find(function(it){return it == dependency}))){
							available.push(cmd);
							return false;
						}
						return true;
					}.bind(this))
				}.bind(this));
				return available;
			},
			_commandFiltered : function(){
				var filt = [];
				for(cmdIdx in this.listaComandos) {
					var cmd = this.listaComandos[cmdIdx];
					if(cmd.description.toLowerCase().indexOf((this.commandFilter||'').toLowerCase()) >= 0) {
						filt.push(cmd)
					}
					if (filt.length > 4) {
						break;
					}
				}
				this.set('listaFiltrada',filt)
			},
			openCommandPallete: function(e) {
				if (! this.$.dlgCmdPallete.opened) {
					this.$.dlgCmdPallete.open()
					setTimeout(function(){
						this.$.commandFilterInput.focus()
					}.bind(this),50)
				} else {
					this.closeCommandPallete();
				}
			},
			closeCommandPallete: function() {
				if (this.$.dlgCmdPallete.opened) {
					this.$.dlgCmdPallete.close()
				}
			},
			_onCommandTap: function(event) {
				this.set('selectedCommandItem',event.srcElement)
				setTimeout(function(){
					var url = this.selectedCommand.action();
					if (url.match(/^((http)|(\/)).*$/g)) {
						window.open(url)
					}
					if (url.match(/^sip:.*$/g)) {
						window.location = url
					}
				}.bind(this),1)
			},
			_actOnShortcut: function(event) {
				var cmdIndex = event.srcElement.dataCommandIndex;
				var url = this.listaComandos[cmdIndex].action();
				if (url.match(/^((http)|(\/)).*$/g)) {
					window.open(url)
				}
				if (url.match(/^sip:.*$/g)) {
					window.location = url
				}
			},
			evaluatePath:function(pathArray) {
				debugger;
				var val = this.get(pathArray[0]);
				pathArray.slice(1).forEach(function(pathPiece){
					val = val[pathPiece];
				})
				return val;
			},
			openUsTasksUrl : function() {
				return this.openUrl("", arguments);
			},
			openUsAccountsUrl : function() {
				return this.openUrl("http://accounts.dev.quintoandar.com.br", arguments);
			},
			openUsPropertiesUrl : function() {
				return this.openUrl("http://props.dev.quintoandar.com.br", arguments);
			},
			openUrl : function(baseUrl, args) {
				return function() {
					var action = baseUrl;
					for(argIndex in args) {
						arg = args[argIndex]
						if (typeof arg === "string") {
							action += arg
						} else if (Array.isArray(arg)) {
							console.info(this.task ? this.task.id : -1)
							action += (this.evaluatePath.bind(this))(arg);
						}
					}
					return action;
				}.bind(this)
			},
			call: function(user) {
				var numberToCall = (user.telefonePrincipal || user.telefoneSecundario || user.telefoneComercial || user.telefoneAnunciante);
				return 'sip: ' + numberToCall.replace(/[^0-9]/g,'').replace(/^\+55/g,'0');
			},
			callOwner: function() {
				return this.call(this.owner)
			},
			callTenant: function() {
				// this.call(this.tenent)
				return this.call({nome:'Teste Tenent',telefonePrincipal:'+5519981287944'})
			}
		});
	</script>
</dom-module>

